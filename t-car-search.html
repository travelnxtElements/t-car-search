<link rel="import" href="../polymer/polymer.html" />
<link rel="import" href="../t-input/t-input.html" />
<link rel="import" href="../t-button/t-button.html" />
<link rel="import" href="../t-checkbox/t-checkbox.html" />
<link rel="import" href="../t-autosuggest/t-autosuggest.html" />
<link rel="import" href="../t-calendar/t-calendar.html" />
<link rel="import" href="../t-text-container/travel-element-styles.html">
<link rel="import" href="../iron-flex-layout/iron-flex-layout-classes.html" />
<dom-module id="t-car-search">
    <style include="iron-flex"></style>
    <style include="travel-element-styles">
    :host {
        font-family: sans-serif;
    }
    
    t-button {
        display: block;
        margin-top: 50px;
    }
    
    div:not(.checkbox) {
        margin-bottom: 15px;
    }
    
    t-checkbox {
        margin-top: 10px;
    }
    </style>
    <template>
        <div>
            <t-autosuggest id="pick-up-location" required selected-item="{{pickupLocation}}" label="Pick-up from" data-url="{{autosuggestApi}}" query-params="{{autosuggestQueryString}}" token-param="formattedAddress" error-message="You missed this."></t-autosuggest>
        </div>
        <div class="checkbox">
            <t-checkbox id="acceptance" checked="{{isDropoffLocationSame}}">Drop-off at same location </t-checkbox>
        </div>
        <div hidden$="{{isDropoffLocationSame}}">
            <t-autosuggest id="drop-off-location" required selected-item="{{dropoffLocation}}" label="Drop-off to" data-url="{{autosuggestApi}}" query-params="{{autosuggestQueryString}}" token-param="formattedAddress" error-message="You missed this."></t-autosuggest>
        </div>
        <div>
            <t-calendar required label="Pick-up date" name="Pick-up date" id="pickupDate" selected-date="{{pickupDate}}" error-msg="You missed this." format="mm/dd/yyyy">
            </t-calendar>
        </div>
        <div>
            <t-calendar required label="Drop-off date" name="Drop-off date" id="dropoffDate" selected-date="{{dropoffDate}}" error-msg="You missed this." format="mm/dd/yyyy">
            </t-calendar>
        </div>
        <div>
            <t-input required error-message="You missed this." id="pick-up-time" label="Pick-up time" value="{{pickupTime}}"></t-input>
        </div>
        <div>
            <t-input required error-message="You missed this." id="drop-off-time" label="Drop-off time" value="{{dropoffTime}}"></t-input>
        </div>
        <div>
            <t-button class="primary block margin-bottom" on-click="searchCars" type="button" label="Search Cars" /></t-button>
        </div>
    </template>
</dom-module>
<script>
Polymer({
    is: "t-car-search",

    properties: {

        pickupLocation: {
            type: String,
            value: ''
        },

        dropoffLocation: {
            type: String,
            value: '',
            observer: '_storeLocation'
        },

        _previousDropoffLocation: {
            type: String,
            value: ''
        },

        pickupDate: {
            type: Date,
            value: null,
            observer: '_pickupDateChanged'
        },

        dropoffDate: {
            type: Date,
            value: null,
            observer: '_dropoffDateChanged'
        },

        pickupTime: {
            type: Date,
            value: null
        },

        dropoffTime: {
            type: Date,
            value: null
        },

        isDropoffLocationSame: {
            type: Boolean,
            value: true,
            observer: '_updateDropoffLocation'
        },

        autosuggestApi: {
            type: String,
            value: ''
        },

        autosuggestQueryString: {
            type: String,
            value: ''
        },

        request: {
            type: Object,
            value: null
        },

        searchId: {
            type: String,
            value: ''
        }
    },

    _storeLocation: function() {
        this._previousDropoffLocation = this.dropoffLocation;
    },

    _getFormattedDate: function(date) {
        if (!date) {
            return null;
        }

        date = new Date(date);

        if (!date) {
            return null;
        }

        date = date.toString();

        date = date.split(' ');

        if (!date || date.length < 4) {
            return;
        }

        date = date.slice(0, 4);
        date[0] += ',';
        date[2] += ',';

        return date.join(' ');
    },

    _updateDropoffLocation: function() {
        if (this.isDropoffLocationSame) {
            var previousValue = this._previousDropoffLocation;
            this.dropoffLocation = this.pickupLocation;
            this._previousDropoffLocation = previousValue;
        } else if (this._previousDropoffLocation) {
            this.dropoffLocation = this._previousDropoffLocation;
        }
    },

    _buildSearchRequest: function() {

        if (!this.dropoffLocation) {
            this.dropoffLocation = this.pickupLocation;
        }

        this.request = {
            productType: "car",
            pickupLocation: {
                name: this.pickupLocation.name,
                geoCode: this.pickupLocation.geoCode,
                type: this.pickupLocation.type,
                code: this.pickupLocation.code,
                formattedAddress: this.pickupLocation.formattedAddress
            },
            pickupDate: {
                date: this._getFormattedDate(this.pickupDate),
                time: this.pickupTime,
            },
            dropoffDate: {
                date: this._getFormattedDate(this.dropoffDate),
                time: this.dropoffTime,
            },
            dropoffLocation: {
                name: this.dropoffLocation.name,
                geoCode: this.dropoffLocation.geoCode,
                type: this.dropoffLocation.type,
                code: this.dropoffLocation.code,
                formattedAddress: this.dropoffLocation.formattedAddress
            }
        };
    },

    _pickupDateChanged: function() {
        this.$.dropoffDate.min = this.$.pickupDate.selectedDate;
        this.$.dropoffDate._changeMinMax();
    },

    _dropoffDateChanged: function() {
        this.$.pickupDate.max = this.$.dropoffDate.selectedDate;
        this.$.pickupDate._changeMinMax();
    },

    searchCars: function() {
        if (!this.validate()) {
            return;
        }

        this._buildSearchRequest();

        this.fire('t-car-search', {
            request: this.request
        });
    },

    onSearchSuccess: function(e) {
        if (!e.detail) {
            console.error("something blew up!");
            return;
        }

        this.searchId = e.detail.searchId;

        this.fire('t-car-search-success', {
            request: this.response
        });
    },

    onSearchError: function(e) {
        console.error("something blew up!");
        console.log(e.detail);
        this.fire('t-car-search-failure', e.detail);
    },

    validate: function() {
        var check = true;
        var requiredFields = this.querySelectorAll('[required]');
        for (var i = 0; i < requiredFields.length; i++) {
            if (!requiredFields[i].validate()) {
                check = false;
            }
        }
        return check;
    }
});
</script>
