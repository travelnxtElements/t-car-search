<link rel="import" href="../polymer/polymer.html" />
<link rel="import" href="../t-input/t-input.html" />
<link rel="import" href="../t-button/t-button.html" />
<link rel="import" href="../t-checkbox/t-checkbox.html" />
<link rel="import" href="../t-autosuggest/t-autosuggest.html" />
<link rel="import" href="../t-calendar/t-calendar.html" />
<link rel="import" href="../t-text-container/travel-element-styles.html">
<link rel="import" href="../iron-flex-layout/iron-flex-layout-classes.html" >

<!--
    <h3>Details:</h3>

        `t-car-search` is a car search component integrated with mystique apis

        The dropoff location selection is optional. It is same as pickup location 
        if isDropoffLocationSame flag is set to true

        This component calls t-car-search-api api component to generate search id.

        components expects an autocomplete api url and a valid mystique api token 
        in order to integrate with t-autosuggest.

    <h3>Object Structure:</h3>

        The component resets iteself if search request in following format is provided 
        in `resetView` method -

            var request = {
                productType: "car",
                pickupLocation: {
                    name: this.pickupLocation.name,
                    geoCode: this.pickupLocation.geoCode,
                    type: this.pickupLocation.type,
                    code: this.pickupLocation.code,
                    formattedAddress: this.pickupLocation.formattedAddress
                },
                pickupDate: {
                    date: this._getFormattedDate(this.pickupDate),
                    time: this.pickupTime,
                },
                dropoffDate: {
                    date: this._getFormattedDate(this.dropoffDate),
                    time: this.dropoffTime,
                },
                dropoffLocation: {
                    name: this.dropoffLocation.name,
                    geoCode: this.dropoffLocation.geoCode,
                    type: this.dropoffLocation.type,
                    code: this.dropoffLocation.code,
                    formattedAddress: this.dropoffLocation.formattedAddress
                }
            };

        `pickupLocation` & `dropoffLocation` properties have following object structure -

            var location = {
                name: this.pickupLocation.name,
                geoCode: this.pickupLocation.geoCode,
                type: this.pickupLocation.type,
                code: this.pickupLocation.code,
                formattedAddress: this.pickupLocation.formattedAddress
            }

    <h3>Events:</h3>

        following events are fired by this component

            1. 't-car-search' - sends car search request object upon successful validation

    <h3>Example:</h3>

        <t-car-search 
            id="searchView"
            autosuggest-api="{{apiBaseUrl}}api/content/autosuggest/"
            auth-token="{{authToken}}"
            on-t-car-search="onSearch">
        </t-car-search>

    @demo demo/index.html
-->

<dom-module id="t-car-search">
    <style include="iron-flex"></style>
    <style include="travel-element-styles">
    :host {
        font-family: sans-serif;
    }
    
    t-button {
        display: block;
        margin-top: 50px;
    }
    
    div:not(.checkbox) {
        margin-bottom: 15px;
    }
    
    t-checkbox {
        margin-top: 10px;
    }
    </style>
    <template>
        <div>
            <t-autosuggest id="pick-up-location" required selected-item="{{pickupLocation}}" label="Pick-up from" data-url="{{autosuggestApi}}" query-params="token={{authToken}}" token-param="formattedAddress" error-message="You missed this."></t-autosuggest>
        </div>
        <div class="checkbox">
            <t-checkbox id="acceptance" checked="{{isDropoffLocationSame}}">Drop-off at same location </t-checkbox>
        </div>
        <div>
            <t-autosuggest  disabled="{{isDropoffLocationSame}}"" id="drop-off-location" required selected-item="{{dropoffLocation}}" label="Drop-off to" data-url="{{autosuggestApi}}" query-params="token={{authToken}}" token-param="formattedAddress" error-message="You missed this."></t-autosuggest>
        </div>
        <div>
            <t-calendar required label="Pick-up date" name="Pick-up date" id="pickupDate" selected-date="{{pickupDate}}" error-msg="You missed this." format="mm/dd/yyyy">
            </t-calendar>
        </div>
        <div>
            <t-calendar required label="Drop-off date" name="Drop-off date" id="dropoffDate" selected-date="{{dropoffDate}}" error-msg="You missed this." format="mm/dd/yyyy">
            </t-calendar>
        </div>
        <div>
            <t-input required error-message="You missed this." id="pick-up-time" label="Pick-up time" value="{{pickupTime}}"></t-input>
        </div>
        <div>
            <t-input required error-message="You missed this." id="drop-off-time" label="Drop-off time" value="{{dropoffTime}}"></t-input>
        </div>
        <div>
            <t-button class="primary block margin-bottom" on-click="searchCars" type="button" label="Search Cars" /></t-button>
        </div>
    </template>
</dom-module>
<script>
Polymer({
    is: "t-car-search",

    properties: {

        /*
         * <p>This is the copy of dropoff location proeprty</p>
         * <p>Not to be used from outside.</p>
        */
        _previousDropoffLocation: {
            type: String,
            value: ''
        },

        /*
         * <p>This stores item selected by pickup location autosuggest</p>
         * <p>The item includes location information like geocode, city code, etc.</p>
        */
        pickupLocation: {
            type: Object,
            value: '',
            observer: '_pickupLocationChanged'
        },

        /*
         * <p>This stores item selected by dropoff location autosuggest</p>
         * <p>The item includes location information like geocode, city code, etc.</p>
         * <p>Observer function keeps a copy of dropoff location to re populate precious data if required.</p>
        */
        dropoffLocation: {
            type: Object,
            value: '',
            observer: '_storeLocation'
        },

        /*
         * <p>This stores the pickup date</p>
         * <p>Observer function resets the min max values for dropoff dates to meet validation constraints.</p>
        */
        pickupDate: {
            type: String,
            value: null,
            observer: '_pickupDateChanged'
        },

        /*
         * <p>This stores the dropoff date.</p>
         * <p>Observer function resets the min max values for pickup dates to meet validation constraints.</p>
        */
        dropoffDate: {
            type: String,
            value: null,
            observer: '_dropoffDateChanged'
        },

        /*
         * <p>This stores the pickup time</p>
        */
        pickupTime: {
            type: String,
            value: null
        },

        /*
         * <p>This stores the dropoff time</p>
        */
        dropoffTime: {
            type: String,
            value: null
        },

        /*
         * <p>This flag switches dropoff location view visibility</p>
         * <p>Observer function updates dropoff location and uses past dropoff value if exists</p>
        */
        isDropoffLocationSame: {
            type: Boolean,
            value: true,
            observer: '_updateDropoffLocation'
        },

        /*
         * <p>This url is used as base api url for t-autosuggest</p>
        */
        autosuggestApi: {
            type: String,
            value: ''
        },

        /*
         * <p>This string is query string parameter containing token value</p>
        */
        authToken: {
            type: String,
            value: ''
        }
    },


    /*
     * <p>Stores the previous value of `dropoffLocation` property</p>
    */
    _storeLocation: function() {
        this._previousDropoffLocation = this.dropoffLocation;
    },

    /*
     * <p>updates dropoffLocation if `isDropoffLocationSame` property is set to true</p>
    */
    _pickupLocationChanged:function () {

        if (this.isDropoffLocationSame) {
            this.dropoffLocation = this.pickupLocation;
        }
        
    },

    /*
     * <p>Returns formatted date required in the search request</p>
    */
    _getFormattedDate: function(date) {
        if (!date) {
            return null;
        }

        date = new Date(date);

        if (!date) {
            return null;
        }

        date = date.toString();

        date = date.split(' ');

        if (!date || date.length < 4) {
            return;
        }

        date = date.slice(0, 4);
        date[0] += ',';
        date[2] += ',';

        return date.join(' ');
    },

    /*
     * <p>Observer function to update dropoff location when `isDropoffLocationSame` property is updated</p>
    */
    _updateDropoffLocation: function() {
        if (this.isDropoffLocationSame) {
            var previousValue = this._previousDropoffLocation;
            this.dropoffLocation = this.pickupLocation;
            this._previousDropoffLocation = previousValue;
        } else if (this._previousDropoffLocation) {
            this.dropoffLocation = this._previousDropoffLocation;
        }
    },

    /*
     * <p>Builds search request</p>
    */
    _buildSearchRequest: function() {

        return {
            productType: "car",
            pickupLocation: {
                name: this.pickupLocation.name,
                geoCode: this.pickupLocation.geoCode,
                type: this.pickupLocation.type,
                code: this.pickupLocation.code,
                formattedAddress: this.pickupLocation.formattedAddress
            },
            pickupDate: {
                date: this._getFormattedDate(this.pickupDate),
                time: this.pickupTime,
            },
            dropoffDate: {
                date: this._getFormattedDate(this.dropoffDate),
                time: this.dropoffTime,
            },
            dropoffLocation: {
                name: this.dropoffLocation.name,
                geoCode: this.dropoffLocation.geoCode,
                type: this.dropoffLocation.type,
                code: this.dropoffLocation.code,
                formattedAddress: this.dropoffLocation.formattedAddress
            }
        };
    },

    /*
     * <p>Observer function to change dropoff date when pickup date is updated</p>
    */
    _pickupDateChanged: function() {

        setTimeout(function(){
            this.$.dropoffDate.min = this.$.pickupDate.selectedDate;
            this.$.dropoffDate._changeMinMax(); 
        }.bind(this), 10);
    },

    /*
     * <p>Observer function to change pickup date when dropoff date is updated</p>
    */
    _dropoffDateChanged: function() {
        setTimeout(function(){
            this.$.pickupDate.max = this.$.dropoffDate.selectedDate;
            this.$.pickupDate._changeMinMax();
        }.bind(this), 10);
    },

    /*
     * <p>Search button event handler</p>
    */
    searchCars: function() {

        if (!this.dropoffLocation) {
            this.dropoffLocation = this.pickupLocation;
        }
        
        if (!this.validate()) {
            return;
        }

        var request = this._buildSearchRequest();

        this.fire('t-car-search', request);
    },

    /*
     * <p>Resets the view if valid search request format is provided</p>
     * <p>Refer request format in documentation</p>
    */
    resetView: function (sessionData) {

        if (!sessionData) {
            return;
        }

        this.pickupLocation = sessionData.pickupLocation;
        this.dropoffLocation = sessionData.dropoffLocation;
        this.isDropoffLocationSame = sessionData.pickupLocation.name === sessionData.dropoffLocation.name;
        this.pickupDate = this._getFormattedDate(sessionData.pickupDate.date);
        this.dropoffDate = this._getFormattedDate(sessionData.dropoffDate.date);
        this.pickupTime = sessionData.pickupDate.time;
        this.dropoffTime = sessionData.dropoffDate.time;
    },

    /*
     * <p>Translates dates to make them compatible with t-calendar</p>
    */
    _getFormattedDate: function (dateString) {
        dateString = new Date(dateString);

        var date = dateString.getDate();
        date = date <= 9 ? '0' + date : date;

        var month = dateString.getMonth() + 1;
        month = month <= 9 ? '0' + month : month;

        var year = dateString.getFullYear();

        return month +'/'+ date +'/'+ year;
    },

    /*
     * <p>validation function</p>
    */
    validate: function() {
        var check = true;
        var requiredFields = this.querySelectorAll('[required]');
        for (var i = 0; i < requiredFields.length; i++) {
            if (requiredFields[i].hidden) {
                continue;
            }

            if (!requiredFields[i].validate()) {
                check = false;
            }
        }
        return check;
    }
});
</script>
