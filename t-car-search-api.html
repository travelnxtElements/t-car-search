<link rel="import" href="../polymer/polymer.html" />
<link rel="import" href="../iron-ajax/iron-ajax.html">
<link rel="import" href="../t-shared-lib/t-provider-behavior.html">
<link rel="import" href="../t-shared-lib/t-date-behavior.html">
<!--
    <h3>Details:</h3>

        `t-car-search-api` is a car search api component integrated with mystique apis.

        It fires mystique search call and returns `searchId` upon successful opearion

    <h3>Object Structure:</h3>

        1. This component uses following request format to search cars -

            var request = {
                "productType": "car",
                "pickupLocation": {
                    "name": "McCarran International Airport",
                    "geoCode": "36.0854,-115.15",
                    "type": "Airport",
                    "code": "LAS",
                    "formattedAddress": "Las Vegas, NV, United States - McCarran International Airport (LAS)"
                },
                "pickupDate": {
                    "date": "06/23/2016",
                    "time": "11 AM"
                },
                "dropoffDate": {
                    "date": "06/25/2016",
                    "time": "12 AM"
                },
                "dropoffLocation": {
                    "name": "McCarran International Airport",
                    "geoCode": "36.0854,-115.15",
                    "type": "Airport",
                    "code": "LAS",
                    "formattedAddress": "Las Vegas, NV, United States - McCarran International Airport (LAS)"
                }
            };

    <h3>Events:</h3>

        following events are fired by this component

            1. 't-car-search-api-success' - fired upon successful search call
            2. 't-car-search-api-error' - fired if search call is failed

    <h3>Example:</h3>

        <t-car-search-api 
            id="searchApi" 
            loading={{loading}} 
            api-base-url="{{apiBaseUrl}}" 
            api-relative-url="api/Car/search" 
            auth-token="{{authToken}}"
            on-t-car-search-api-success="onSearchSuccess"
            on-t-car-search-api-error="onSearchError">
        </t-car-search-api>

    @demo demo/index.html
-->
<dom-module id="t-car-search-api">
    <template>
        <iron-ajax id="ajaxCall" method="POST" content-type="application/json" handle-as="json" verbose>
        </iron-ajax>
    </template>
</dom-module>
<script>
(function() {

    Polymer({
        is: 't-car-search-api',

        /*
         * <p>Behaviour to validate ajax parameters and handle error codes.</p>
         */
        behaviors: [
            TravelNxt.Behaviors.ProviderBehavior,
            TravelNxt.Behaviors.DateBehavior
        ],

        listeners: {
            'ajaxCall.response': '_successCallback',
            'ajaxCall.error': '_errorCallback'
        },

        /*
         * <p>Method to search cars</p>
         */
        search: function(data) {

            if (!data) {
                throw Error("search request is mandetory");
            }

            if (this._validateApiMeta()) {
                this.$.ajaxCall.url = this._getUrl();
                this.$.ajaxCall.body = JSON.stringify(this._buildData(data));
                this.$.ajaxCall.generateRequest();
            }
        },

        _buildData: function(data) {
            return {
                productType: "car",
                pickupLocation: {
                    name: data.pickupLocation.name,
                    geoCode: data.pickupLocation.geoCode,
                    type: data.pickupLocation.type,
                    code: data.pickupLocation.code,
                    formattedAddress: data.pickupLocation.formattedAddress,
                    cityName: data.pickupLocation.cityName,
                    countryCode: data.pickupLocation.countryCode,
                    countryName: data.pickupLocation.countryName,
                    stateCode: data.pickupLocation.stateCode,
                    stateName: data.pickupLocation.stateName
                },
                pickupDate: {
                    date: this._getFormattedDate(data.pickupDate),
                    time: data.pickupTime,
                },
                dropoffDate: {
                    date: this._getFormattedDate(data.dropoffDate),
                    time: data.dropoffTime,
                },
                dropoffLocation: {
                    name: data.dropoffLocation.name,
                    geoCode: data.dropoffLocation.geoCode,
                    type: data.dropoffLocation.type,
                    code: data.dropoffLocation.code,
                    formattedAddress: data.dropoffLocation.formattedAddress,
                    cityName: data.dropoffLocation.cityName,
                    countryCode: data.dropoffLocation.countryCode,
                    countryName: data.dropoffLocation.countryName,
                    stateCode: data.dropoffLocation.stateCode,
                    stateName: data.dropoffLocation.stateName
                }
            };
        },
     /*
         * <p>Translates dates to make them compatible with t-calendar</p>
        */
        _getFormattedDate: function (dateString) {

            //changed the date format to match the format added templar site
            //need to find a solution to get the format from templar to create date objects.
            var dateComponents = this._getDateComponents(dateString);
            return  dateComponents.day + ', ' + 
                    dateComponents.monthIndex + '/' + 
                    dateComponents.date + '/' +
                    dateComponents.year
        },
        /*
         * <p>Success callback</p>
         */
        _successCallback: function(event) {
            this._successHandler(event);
        },


        /*
         * <p>error callback</p>
         */
        _errorCallback: function(event) {
            this._errorHandler(event);
        }

    });
})();
</script>
