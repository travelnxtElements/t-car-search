<link rel="import" href="../polymer/polymer.html" />
<link rel="import" href="t-car-search.html">
<link rel="import" href="t-car-search-api.html">
<link rel="import" href="../t-mystique-auth/t-mystique-auth.html">
<link rel="import" href="../t-sessionstorage/t-sessionstorage.html">
<link rel="import" href="../t-notify/t-notify.html">

<!--
    <h3>Details:</h3>

        `t-car-search-page` is a car search page component integrated with mystique apis.

        It uses following child components in it -
            1. `t-car-search`
            2. `t-car-search-api`
            3. `t-sessionstorage`
            4. `t-notify`

    <h3>Object Structure:</h3>

        1. The component resets iteself if search request in following format is provided 
           in `resetView` method -

            var request = {
                "productType": "car",
                "pickupLocation": {
                    "name": "McCarran International Airport",
                    "geoCode": "36.0854,-115.15",
                    "type": "Airport",
                    "code": "LAS",
                    "formattedAddress": "Las Vegas, NV, United States - McCarran International Airport (LAS)"
                },
                "pickupDate": {
                    "date": "06/23/2016",
                    "time": "11 AM"
                },
                "dropoffDate": {
                    "date": "06/25/2016",
                    "time": "12 AM"
                },
                "dropoffLocation": {
                    "name": "McCarran International Airport",
                    "geoCode": "36.0854,-115.15",
                    "type": "Airport",
                    "code": "LAS",
                    "formattedAddress": "Las Vegas, NV, United States - McCarran International Airport (LAS)"
                }
            };

        2.  `pickupLocation` & `dropoffLocation` properties have following object structure -

            var location = {
                name: this.pickupLocation.name,
                geoCode: this.pickupLocation.geoCode,
                type: this.pickupLocation.type,
                code: this.pickupLocation.code,
                formattedAddress: this.pickupLocation.formattedAddress
            }

    <h3>Events:</h3>

        following events are fired by this component

            1. 't-car-search-success' - fired upon successful search call
            2. 't-car-search-error' - fired if search call is failed

    <h3>Example:</h3>

        <t-car-search-page
            id="searchPage"
            api-base-url="http://qa-mystiquecode.tavisca.com/"
            auth-token="{{tokenResponse.authenticationToken}}"
            api-url-format="/api/Session/SESSIONKEY">
        </t-car-search-page>

    @demo demo/index.html
-->


<dom-module id="t-car-search-page">
    <template>
        <style>
            :host {
                display: block;
            }
        </style>

        <t-notify id="notify" message="" type="error"></t-notify>
        
        <t-car-search 
            id="searchView"
            autosuggest-api="{{apiBaseUrl}}api/content/autosuggest/"
            auth-token="{{authToken}}"
            on-t-car-search="onSearch">
        </t-car-search>

        <t-car-search-api 
            id="searchApi" 
            loading={{loading}} 
            api-base-url="{{apiBaseUrl}}" 
            api-relative-url="api/Car/search" 
            auth-token="{{authToken}}"
            on-t-car-search-api-success="onSearchSuccess"
            on-t-car-search-api-error="onSearchError">
        </t-car-search-api>

        <t-sessionstorage
            id="sessionStore"
            api-url-format="{{apiUrlFormat}}"
            on-t-sessionstorage-save-success="onSessionSave"
            on-t-sessionstorage-load-success="onSessionLoad">
        </t-sessionstorage>

    </template>
</dom-module>
    <script>
    (function () {
        Polymer({
            is: 't-car-search-page',

            properties: {

                /*
                 * <p>This url is used as base api url for `t-autosuggest`</p>
                */
                autosuggestApi: {
                    type: String,
                    value: ''
                },

                /*
                 * <p>This string is query string containing token value</p>
                */
                authToken: {
                    type: String,
                    value: ''
                },

                /*
                 * <p>This property holds the value of api base URL</p>
                */
                apiBaseUrl: {
                    type: String,
                    value: ''
                },

                /*
                 * <p>This property holds the value of web api URL format</p>
                */
                apiUrlFormat: {
                    type: String,
                    value: ''
                },

                /*
                 * <p>This property is collection of keys used to store data in session</p>
                */
                _sessionKeys: {
                    type: Object,
                    value: function () {                        
                        return {
                            searchCriteria : 'CAR_SEARCH_CRITERIA',
                            searchId:'CAR_SEARCH_ID'
                        };
                    },
                    readOnly: true
                },
            },


            attached: function () {
                this._getFromSessionStore(this._sessionKeys.searchCriteria);
            },

            /*
             * <p>This page component level method to save data in session</p>
             * <p>This should be moved in page component behaviour</p>
            */
            _saveInSessionStore: function (key, value) {

                if (!key || !value) {
                    return;
                }

                this.$.sessionStore.key = key;
                this.$.sessionStore.value = value;

                this.$.sessionStore.save();
            },

            /*
             * <p>This is page component level method to get data from session</p>
             * <p>This should be moved in page component behaviour</p>
            */
            _getFromSessionStore: function (key) {

                if (!key) {
                    return;
                }

                this.$.sessionStore.key = key;

                return this.$.sessionStore.load();
            },

            /*
             * <p>Event handler method called when `t-car-search` event is fired</p>
            */
            onSearch: function (e) {
                this._saveInSessionStore(this._sessionKeys.searchCriteria, e.detail);
                this.$.searchApi.search(e.detail);
            },

            /*
             * <p>Event handler method called when `t-car-search-api-success` event is fired</p>
            */
            onSearchSuccess: function (e) {
                if (!e.detail) {
                    this.$.notify.active = true;
                    this.$.notify.message = event.detail.code + ' - ' + event.detail.message;
                    console.error('something blew up!');
                    return;
                }

                this._saveInSessionStore(this._sessionKeys.searchId, e.detail.searchId);
            },

            /*
             * <p>Event handler method called when `t-car-search-api-error` event is fired</p>
            */
            onSearchError: function (e) {
                this.$.notify.active = true;
                this.$.notify.message = event.detail.code + ' - ' + event.detail.message;
                console.error(e.detail);
                this.fire('t-car-search-error', e.detail);
            },

            /*
             * <p>Event handler method called when `t-sessionstorage-save-success` event is fired</p>
            */
            onSessionSave: function (e) {
                if (this.$.sessionStore.key === this._sessionKeys.searchId) {
                    this.fire('t-car-search-success', {
                        request: this.response
                    });
                }
            },

            /*
             * <p>Event handler method called when `t-sessionstorage-load-success` event is fired</p>
            */
            onSessionLoad: function (e) {
                if (this.$.sessionStore.key === this._sessionKeys.searchCriteria) {
                    this.resetView();
                }
            },

            /*
             * <p>This method resets the view by using saved data in session</p>
             * <p>It calles child views' resetView method to propogate the reset event</p>
            */
            resetView: function () {
                if (!this.$.sessionStore.value) {
                    return;
                }

                this.$.searchView.resetView(this.$.sessionStore.value);
            }
        });        
    })();
    </script>